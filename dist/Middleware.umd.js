(function(s,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(s=typeof globalThis<"u"?globalThis:s||self,a(s.Middleware={}))})(this,function(s){"use strict";var A=Object.defineProperty;var E=(s,a,h)=>a in s?A(s,a,{enumerable:!0,configurable:!0,writable:!0,value:h}):s[a]=h;var l=(s,a,h)=>(E(s,typeof a!="symbol"?a+"":a,h),h);class a{constructor(i,e,t){l(this,"validator");l(this,"key");l(this,"args");this.validator=i,this.key=e,this.args=typeof t=="string"?t.split(","):[].concat(...t||[])}static make(i,e,t){return i instanceof this?i:new this(i,e,t)}async validate(i,e,t){return await this.validator(i,e,t,...this.args)}}function h(n){var i=[];return p(n,i),i}function p(n,i){for(var e=0;e<n.length;e++){var t=n[e];Array.isArray(t)?p(t,i):i.push(t)}}class g{constructor(){l(this,"aliases");l(this,"groups");l(this,"middlewares",[]);l(this,"priorities",[]);this.aliases=new Map,this.middlewares=[],this.groups=new Map,this.priorities=[]}alias(i,e){return this.aliases.set(i,e),this}group(i,e){return this.groups.set(i,e),this}middleware(i){return this.middlewares.push(i),this}priority(...i){return this.priorities=[].concat(...i),this}prioritize(...i){return[].concat(...i).sort((e,t)=>{let r=this.priorities.indexOf(e.key||e.validator),o=this.priorities.indexOf(t.key||t.validator);return r>-1&&o>-1?r<o?-1:1:r>-1?-1:1})}resolve(...i){return h([].concat(...i).map(e=>{if(Array.isArray(e))return this.resolve(e);if(typeof e=="function")return a.make(e);const[t,r]=this.definition(e);if(this.aliases.has(t))return a.make(this.aliases.get(t),t,...r);if(this.groups.has(t))return this.resolve(this.groups.get(t))}))}definition(i){const[e,t]=String(i).split(":");return[e,t?t.split("."):[]].filter(r=>!!r)}prioritized(...i){return this.prioritize(this.resolve([...this.middlewares,...i]).filter(e=>e instanceof a))}}function m(n,i,e){return new Promise(async(t,r)=>{const o=[...n];return function u(d){const y=o.shift();return y?y.validate(i,e,f=>{f instanceof Error?r(f):f===!1?r(new Error(`Cancelling navigation to ${i.path}!`)):u(f)}):t(d)}()})}class w{constructor(i,e){l(this,"beforeEnter");l(this,"validators",[]);l(this,"callbacks",[]);this.registry=i,this.rawRoute=e;for(const[t,r]of Object.entries(e))this[t]=r;this.beforeEnter=async(t,r,o)=>{const u=m(this.middlewares,t,r);for(const d of this.callbacks)d(u,{to:t,from:r,next:o});await u.then(o).catch(d=>{})}}get middlewares(){return this.registry.prioritized(this.validators)}middleware(i){return this.validators.push(i),this}catch(i){return this.callbacks.push((e,{to:t,from:r,next:o})=>{e.catch(i&&(u=>i({error:u,to:t,from:r,next:o})))}),this}then(i,e){return this.callbacks.push((t,{to:r,from:o,next:u})=>{t.then(i&&(d=>i({status:d,to:r,from:o,next:u})),e&&(d=>e({error:d,to:r,from:o,next:u})))}),this}finally(i){return this.callbacks.push((e,{to:t,from:r,next:o})=>{e.finally(i&&(()=>i({to:t,from:r,next:o})))}),this}}let c=new g;function k(...n){return c.alias(...n)}function v(...n){return c.group(...n)}function b(...n){return c.middleware(...n)}function M(...n){return c.priority(...n)}function z(n){return new w(c,n)}s.Middleware=a,s.MiddlewareRegistry=g,s.MiddlewareRoute=w,s.alias=k,s.group=v,s.middleware=b,s.priority=M,s.registrar=c,s.route=z,Object.defineProperties(s,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
