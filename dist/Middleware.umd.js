(function(r,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(r=typeof globalThis<"u"?globalThis:r||self,a(r.Middleware={}))})(this,function(r){"use strict";var A=Object.defineProperty;var E=(r,a,h)=>a in r?A(r,a,{enumerable:!0,configurable:!0,writable:!0,value:h}):r[a]=h;var l=(r,a,h)=>(E(r,typeof a!="symbol"?a+"":a,h),h);class a{constructor(i,e,t){l(this,"validator");l(this,"key");l(this,"args");this.validator=i,this.key=e,this.args=typeof t=="string"?t.split(","):[].concat(...t||[])}static make(i,e,t){return i instanceof this?i:new this(i,e,t)}async validate(i,e,t){return await this.validator(i,e,t,...this.args)}}function h(n){var i=[];return p(n,i),i}function p(n,i){for(var e=0;e<n.length;e++){var t=n[e];Array.isArray(t)?p(t,i):i.push(t)}}class g{constructor(){l(this,"aliases");l(this,"groups");l(this,"middlewares",[]);l(this,"priorities",[]);this.aliases=new Map,this.middlewares=[],this.groups=new Map,this.priorities=[]}alias(i,e){return this.aliases.set(i,e),this}group(i,e){return this.groups.set(i,e),this}middleware(i){return this.middlewares.push(i),this}priority(...i){return this.priorities=[].concat(...i),this}prioritize(...i){return[].concat(...i).sort((e,t)=>{let s=this.priorities.indexOf(e.key||e.validator),o=this.priorities.indexOf(t.key||t.validator);return s>-1&&o>-1?s<o?-1:1:s>-1?-1:1})}resolve(...i){return h([].concat(...i).map(e=>{if(Array.isArray(e))return this.resolve(e);if(typeof e=="function")return a.make(e);const[t,s]=this.definition(e);if(this.aliases.has(t))return a.make(this.aliases.get(t),t,s);if(this.groups.has(t))return this.resolve(this.groups.get(t))}))}definition(i){const[e,t]=String(i).split(":");return[e,t?t.split("."):[]]}prioritized(...i){return this.prioritize(this.resolve([...this.middlewares,...i]).filter(e=>e instanceof a))}}function m(n,i,e){return new Promise(async(t,s)=>{const o=[...n];return function d(u){const y=o.shift();return y?y.validate(i,e,f=>{f instanceof Error?s(f):f===!1?s(new Error(`Cancelling navigation to ${i.path}!`)):[!0,void 0].includes(f)?d(f):t(f)}):t(u)}()})}class w{constructor(i,e){l(this,"beforeEnter");l(this,"validators",[]);l(this,"callbacks",[]);this.registry=i,this.rawRoute=e;for(const[t,s]of Object.entries(e))this[t]=s;this.beforeEnter=async(t,s,o)=>{const d=m(this.middlewares,t,s);for(const u of this.callbacks)u(d,{to:t,from:s,next:o});await d.then(o).catch(u=>{})}}get middlewares(){return this.registry.prioritized(this.validators)}middleware(i){return this.validators.push(i),this}catch(i){return this.callbacks.push((e,{to:t,from:s,next:o})=>{e.catch(i&&(d=>i({error:d,to:t,from:s,next:o})))}),this}then(i,e){return this.callbacks.push((t,{to:s,from:o,next:d})=>{t.then(i&&(u=>i({status:u,to:s,from:o,next:d})),e&&(u=>e({error:u,to:s,from:o,next:d})))}),this}finally(i){return this.callbacks.push((e,{to:t,from:s,next:o})=>{e.finally(i&&(()=>i({to:t,from:s,next:o})))}),this}}let c=new g;function k(n,i){return c.alias(n,i)}function v(n,i){return c.group(n,i)}function b(n){return c.middleware(n)}function M(...n){return c.priority(...n)}function z(n){return new w(c,n)}r.Middleware=a,r.MiddlewareRegistry=g,r.MiddlewareRoute=w,r.alias=k,r.group=v,r.middleware=b,r.priority=M,r.registrar=c,r.route=z,Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
