(function(n,h){typeof exports=="object"&&typeof module!="undefined"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(n=typeof globalThis!="undefined"?globalThis:n||self,h(n.Middleware={}))})(this,function(n){"use strict";function h(r){var t=[];return g(r,t),t}function g(r,t){for(var i=0;i<r.length;i++){var e=r[i];Array.isArray(e)?g(e,t):t.push(e)}}const b=/^on_?([A-Z]?[a-z]+)?/;function u(r){const t=r.match(b);return(t&&t[1]?t[1]:r).toLowerCase()}function y(r,t,i,e){return new Promise(async(s,a)=>{let o=!1;for(;!o&&r.length;)await r.shift().validate(t,i,(...p)=>{o=!0,e(...p),s(!1)}).catch(p=>{o=!0,a(p)});s(!0)})}class w{set callbacks(t){this.$callbacks=t}get callbacks(){return this.$callbacks||(this.callbacks={}),this.$callbacks}on(t,i){if(typeof i!="function")throw new Error("Callback must be an instance of a `Function`.");return t=u(t),this.callbacks[t]===void 0&&(this.callbacks[t]=[]),this.callbacks[t].push(i),this}once(t,i){t=u(t);const e=(...s)=>{this.off(t,e),i(...s)};return this.on(t,e)}off(t,i){t=u(t);const e=this.callbacks[t]&&this.callbacks[t].indexOf(i);return e>-1&&this.callbacks[t].splice(e,1),this}emit(t,...i){return t=u(t),this.callbacks[t]&&[].concat(this.callbacks[t]).forEach(e=>e(...i)),this}}class f{constructor(t,i,e){this.validator=t,this.key=i,this.args=typeof e=="string"?e.split(","):[].concat(...e||[])}static make(t,...i){return t instanceof this?t:new this(t,...i)}async validate(t,i,e){return await this.validator(t,i,e,...this.args)}}class l extends w{constructor(){super();this.aliases=new Map,this.middlewares=[],this.groups=new Map,this.priorities=[]}alias(t,i){return this.aliases.set(t,i),this}group(t,i){return this.groups.set(t,i),this}middleware(t){return this.middlewares.push(t),this}priority(...t){return this.priorities=[].concat(...t),this}prioritize(...t){return[].concat(...t).sort((i,e)=>{let s=this.priorities.indexOf(i.key||i.validator),a=this.priorities.indexOf(e.key||e.validator);return s>-1&&a>-1?s<a?-1:1:s>-1?-1:1})}resolve(...t){return h([].concat(...t).map(i=>{if(Array.isArray(i))return this.resolve(i);if(typeof i=="function")return f.make(i);const[e,s]=this.definition(i);if(this.aliases.has(e))return f.make(this.aliases.get(e),e,...s);if(this.groups.has(e))return this.resolve(this.groups.get(e))}))}definition(t){const[i,e]=String(t).split(":");return[i,e?e.split("."):[]].filter(s=>!!s)}prioritized(...t){return this.prioritize(this.resolve([...this.middlewares,...t]).filter(i=>i instanceof f))}}class m extends w{constructor(t,i){super();if(this.options=Object.assign({catch:[],middleware:[],registrar:new l,then:[]},i),!(this.registrar instanceof l))throw Error("The `registrar` property must be an instance of MiddlewareRegistry");this.intializeBeforeEnter(),this.initializeRoute(t)}intializeBeforeEnter(){this.beforeEnter=async(t,i,e)=>{const s=y(this.middlewares,t,i,e).then(a=>{e(),a&&this.options.then.length&&this.options.then.reduce((o,d)=>o.then(()=>d(t,i,e)),s)});this.options.catch.length&&this.options.catch.reduce((a,o)=>a.catch(d=>o(d,t,i,e)),s)}}initializeRoute(t){typeof t=="string"&&(t={path:t});for(const[i,e]of Object.entries(t))Object.defineProperty(this,i,{value:e,writable:!0})}catch(t){return this.options.catch.push(t),this}emit(...t){return this.registrar&&this.registrar.emit(...t),super.emit(...t)}middleware(t,i){return this.options.middleware.push(t),this}then(t){return this.options.then.push(t),this}get middlewares(){return this.registrar.prioritized(this.options.middleware)}get registrar(){return this.options.registrar||new l}}let c=new l;function M(...r){return c.alias(...r)}function k(...r){return c.group(...r)}function v(...r){return c.middleware(...r)}function z(...r){return c.priority(...r)}function E(r,t){return new m(r,Object.assign({registrar:c},t))}n.MiddlewareRegistry=l,n.MiddlewareRoute=m,n.alias=M,n.group=k,n.middleware=v,n.priority=z,n.registrar=c,n.route=E,Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
