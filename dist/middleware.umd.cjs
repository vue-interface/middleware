(function(n,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(n=typeof globalThis<"u"?globalThis:n||self,a(n.Middleware={}))})(this,function(n){"use strict";var C=Object.defineProperty;var I=(n,a,h)=>a in n?C(n,a,{enumerable:!0,configurable:!0,writable:!0,value:h}):n[a]=h;var r=(n,a,h)=>(I(n,typeof a!="symbol"?a+"":a,h),h);class a{constructor(t,i,e){r(this,"args");this.validator=t,this.key=i,this.validator=t,this.args=typeof e=="string"?e.split(","):[].concat(...e||[])}async validate(t,i,e){return await this.validator(t,i,e,...this.args)}}class h{constructor(){r(this,"aliases");r(this,"groups");r(this,"middlewares",[]);r(this,"priorities",[]);this.aliases=new Map,this.middlewares=[],this.groups=new Map,this.priorities=[]}alias(t,i){return this.aliases.set(t,i),this}group(t,i){return this.groups.set(t,i),this}middleware(t){return this.middlewares.push(t),this}priority(t){return this.priorities=t,this}prioritize(t){return t.sort((i,e)=>{const o=this.priorities.indexOf(i.key||i.validator),l=this.priorities.indexOf(e.key||e.validator);return o>-1&&l>-1?o<l?-1:1:o>-1?-1:1})}resolve(t){return t.map(i=>{if(i instanceof a)return i;if(typeof i=="function")return new a(i);const[e,o]=this.definition(i),l=this.aliases.get(e);return l?new a(l,e,o):this.resolve(this.groups.get(e))}).flat(1)}definition(t){const[i,e]=t.split(":");return[i,e?e.split("."):[]]}prioritized(t){const i=this.resolve([...this.middlewares,...t]).filter(e=>e instanceof a);return this.prioritize(i)}}function g(s,t,i){return new Promise(async(e,o)=>{const l=[...s];return function d(p){const m=l.shift();return m?m.validate(t,i,f=>{f instanceof Error?o(f):f===!1?o(new Error(`Cancelling navigation to ${t.path}!`)):[!0,void 0].includes(f)?d(f):e(f)}):e(p)}()})}class u{constructor(t,i){r(this,"path");r(this,"alias",[]);r(this,"name");r(this,"beforeEnter");r(this,"meta");r(this,"validators",[]);r(this,"callbacks",[]);this.registry=t,i.alias&&(this.alias=Array.isArray(i.alias)?i.alias:[i.alias]),this.path=i.path,this.name=i.name,this.beforeEnter=i.beforeEnter,this.meta=i.meta,this.beforeEnter=async(e,o,l)=>{const d=g(this.middlewares,e,o);for(const p of this.callbacks)p(d,{to:e,from:o,next:l});await d.then(l).catch(p=>{})}}get middlewares(){return this.registry.prioritized(this.validators)}middleware(...t){for(const i of t.flat(1))this.validators.push(i);return this}catch(t){return this.callbacks.push((i,{to:e,from:o,next:l})=>{i.catch(t&&(d=>t({error:d,to:e,from:o,next:l})))}),this}then(t,i){return this.callbacks.push((e,{to:o,from:l,next:d})=>{e.then(t&&(p=>t({status:p,to:o,from:l,next:d})),i&&(p=>i({error:p,to:o,from:l,next:d})))}),this}finally(t){return this.callbacks.push((i,{to:e,from:o,next:l})=>{i.finally(t&&(()=>t({to:e,from:o,next:l})))}),this}}class y extends u{constructor(i,e){super(i,e);r(this,"component");r(this,"props");this.component=e.component,this.props=e.props}}class w extends u{constructor(i,e){super(i,e);r(this,"component");r(this,"children");r(this,"props");this.component=e.component,this.children=e.children,this.props=e.props}}class M extends u{constructor(i,e){super(i,e);r(this,"component");r(this,"components");r(this,"props");this.registry=i,this.rawRoute=e,this.components=e.components,this.props=e.props}}class v extends u{constructor(i,e){super(i,e);r(this,"components");r(this,"component");r(this,"children");r(this,"props");this.registry=i,this.rawRoute=e,this.components=e.components,this.children=e.children,this.props=e.props}}class b extends u{constructor(i,e){super(i,e);r(this,"redirect");this.registry=i,this.rawRoute=e,this.redirect=e.redirect}}const c=new h;function k(s,t){return c.alias(s,t)}function E(s,t){return c.group(s,t)}function z(s){return c.middleware(s)}function S(s){return c.priority(s)}function V(s){if(s.children&&s.components)return new v(c,s);if(s.children&&s.component)return new w(c,s);if(!s.children&&s.components)return new M(c,s);if(!s.children&&s.component)return new y(c,s);if(!s.children&&s.redirect)return new b(c,s);throw new Error("Invalid route!")}n.Middleware=a,n.MiddlewareRegistry=h,n.alias=k,n.group=E,n.middleware=z,n.priority=S,n.registrar=c,n.route=V,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=middleware.umd.cjs.map
